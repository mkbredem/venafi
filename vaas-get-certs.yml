---
- name: Gather Venafi Cloud applications and certificates
  hosts: localhost
  connection: local
  gather_facts: false

  vars:
    # === Required ===
    vaas_api_key: "{{ venafi_api_key }}"   # or inject via AAP credential as a variable
    tenant_base_url: "https://eval-85300634.venafi.cloud" # your tenant base
    global_api_url:  "https://api.venafi.cloud"
    # Many APIs are also available under api.venafi.cloud; most tenants proxy on their base URL too.

    # === Tuning ===
    cert_limit: 1000
    cert_params: "ownershipTree=false&excludeSupersededInstances=false"

    target_domains:
      - mkbredem.com
      - mbredeme.com

  tasks:
    - name: Publish mbredeme appID and issuingTemplateId 
      ansible.builtin.set_stats:
        data:
          app_data:
              app_id: "0fe2a8a0-7981-11f0-883f-df2452f1f876"
              template_id: "e1d81b71-6e54-11f0-b1b4-9323192b9202" #defeault template

    # --- Certificates (Outage Detection API) ---
    # NOTE: This grabs up to 'cert_limit' results. If you have more, see 'Pagination' note below.
    - name: Get Certificates (up to {{ cert_limit }})
      ansible.builtin.uri:
        url: "https://api.venafi.cloud/outagedetection/v1/certificates?ownershipTree=false&excludeSupersededInstances=false&limit=1000"
        method: GET
        headers:
          accept: "application/json"
          tppl-api-key: "{{ vaas_api_key | default('REDACT_ME') }}"
        return_content: true
        status_code: [200]
      register: vaas_certs

    - name: Parse cert JSON (prefer .json, fall back to .content)
      ansible.builtin.set_fact:
        vaas_parsed_certs: "{{ vaas_certs.json | default(vaas_certs.content | from_json) }}"

    - name: List cert names
      ansible.builtin.debug:
        msg: "{{ vaas_parsed_certs.certificates | map(attribute='certificateName') | list }}"

    - name: Normalize cert list from response
      ansible.builtin.set_fact:
        cert_list: "{{ vaas_parsed_certs.get('certificates', vaas_parsed_certs.get('items', [])) }}"
    
    - name: Debug full cert objects where name contains "mkbredem" (pretty JSON)
      ansible.builtin.debug:
        msg: "{{ (cert_list | selectattr('certificateName', 'search', 'mkbredem') | list) | to_nice_json }}"

    - name: Publish refresh_certificates with all matching cert objects
      ansible.builtin.set_stats:
        data:
          refresh_certificates: >-
            {{
              cert_list
              | selectattr('certificateName', 'search', 'mkbredem')
              | list
            }}

#    - name: Show matching certs_json
#      ansible.builtin.debug:
#        var: hostvars[loalhost]['ansible_stats'][''data']['refresh_certificates']